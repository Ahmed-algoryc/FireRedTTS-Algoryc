
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Voice Chat</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .chat-container {
            border: 1px solid #ddd;
            border-radius: 10px;
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 20px;
            background: #f9f9f9;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }
        
        .user-message {
            background: #007bff;
            color: white;
            margin-left: 20%;
        }
        
        .ai-message {
            background: #e9ecef;
            color: #333;
            margin-right: 20%;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .voice-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 150px;
        }
        
        .message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .send-button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .send-button:hover {
            background: #0056b3;
        }
        
        .send-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .voice-clone-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .voice-clone-section h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .clone-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .voice-name-input, .transcription-input {
            flex: 1;
            min-width: 150px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .audio-file-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .clone-button {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .clone-button:hover {
            background: #218838;
        }
        
        .clone-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .clone-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .clone-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .clone-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .clone-status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .audio-controls {
            text-align: center;
            margin-top: 20px;
        }
        
        .play-button {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .play-button:hover {
            background: #218838;
        }
        
        .audio-queue {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ­ Real-time Voice Chat</h1>
        
        <div id="status" class="status disconnected">
            Connecting to server...
        </div>
        
        <div class="input-container">
            <select id="voiceSelect" class="voice-select">
                <option value="">Select Voice...</option>
            </select>
            <input type="text" id="messageInput" class="message-input" placeholder="Type your message here..." maxlength="200">
            <button id="sendButton" class="send-button">Send</button>
            <button id="deleteVoiceButton" class="send-button" style="background:#dc3545">Delete Voice</button>
        </div>
        
        <div class="voice-clone-section">
            <h3>ðŸŽ­ Clone New Voice</h3>
            <div class="clone-container">
                <input type="text" id="voiceNameInput" placeholder="Voice name (e.g., 'my_voice')" class="voice-name-input">
                <input type="text" id="transcriptionInput" placeholder="What's said in the audio? (optional - will auto-transcribe)" class="transcription-input">
                <input type="file" id="audioFileInput" accept="audio/*" class="audio-file-input">
                <button id="cloneButton" class="clone-button">Clone Voice</button>
            </div>
            <div id="cloneStatus" class="clone-status"></div>
        </div>
        
        <div id="chatContainer" class="chat-container">
            <div class="message ai-message">
                Welcome! Select a voice and start chatting. Your AI responses will be generated in real-time with voice synthesis.
            </div>
        </div>
        
        <div class="audio-controls">
            <button id="playAllButton" class="play-button" style="display: none;">Play All Audio</button>
            <div id="audioQueue" class="audio-queue"></div>
        </div>
    </div>

    <script>
        class VoiceChat {
            constructor() {
                this.ws = null;
                this.audioQueue = [];
                this.isPlaying = false;
                this.currentAudio = null;
                
                this.initializeElements();
                this.connect();
                this.setupEventListeners();
            }
            
            initializeElements() {
                this.statusEl = document.getElementById('status');
                this.voiceSelect = document.getElementById('voiceSelect');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.deleteVoiceButton = document.getElementById('deleteVoiceButton');
                this.chatContainer = document.getElementById('chatContainer');
                this.playAllButton = document.getElementById('playAllButton');
                this.audioQueueEl = document.getElementById('audioQueue');
                
                // Voice cloning elements
                this.voiceNameInput = document.getElementById('voiceNameInput');
                this.transcriptionInput = document.getElementById('transcriptionInput');
                this.audioFileInput = document.getElementById('audioFileInput');
                this.cloneButton = document.getElementById('cloneButton');
                this.cloneStatus = document.getElementById('cloneStatus');
            }
            
            connect() {
                // Use the same URL as the current page but with /ws endpoint
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                console.log('Connecting to WebSocket:', wsUrl);
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    this.updateStatus('Connected to server', 'connected');
                    this.loadVoices();
                };
                
                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleMessage(data);
                };
                
                this.ws.onclose = () => {
                    this.updateStatus('Disconnected from server', 'disconnected');
                    setTimeout(() => this.connect(), 3000);
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.updateStatus('Connection error', 'disconnected');
                };
            }
            
            updateStatus(message, type) {
                this.statusEl.textContent = message;
                this.statusEl.className = `status ${type}`;
            }
            
            loadVoices() {
                this.ws.send(JSON.stringify({ type: 'get_voices' }));
            }
            
            handleMessage(data) {
                switch (data.type) {
                    case 'voices':
                        this.populateVoiceSelect(data.voices);
                        break;
                    case 'chat_start':
                        this.addMessage('AI is thinking...', 'ai-message');
                        break;
                    case 'text_chunk':
                        this.updateLastMessage(data.full_text, 'ai-message');
                        break;
                    case 'audio_chunk':
                        this.addAudioToQueue(data.audio, data.text);
                        break;
                    case 'chat_complete':
                        // Keep the GPT response visible; just append a subtle status line
                        this.addMessage('Response complete', 'ai-message');
                        // Re-enable input immediately for next query
                        this.sendButton.disabled = false;
                        break;
                    case 'clone_success':
                        this.showCloneStatus(data.message, 'success');
                        this.loadVoices(); // Refresh voice list
                        this.resetCloneForm();
                        break;
                    case 'clone_error':
                        this.showCloneStatus(data.message, 'error');
                        this.resetCloneForm();
                        break;
                    case 'clone_status':
                        this.showCloneStatus(data.message, 'info');
                        break;
                    case 'delete_success':
                        this.showCloneStatus(data.message, 'success');
                        this.loadVoices();
                        break;
                    case 'delete_error':
                        this.showCloneStatus(data.message, 'error');
                        break;
                    case 'error':
                        this.addMessage(`Error: ${data.message}`, 'ai-message');
                        break;
                }
            }
            
            populateVoiceSelect(voices) {
                this.voiceSelect.innerHTML = '<option value="">Select Voice...</option>';
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice;
                    option.textContent = voice;
                    this.voiceSelect.appendChild(option);
                });
            }
            
            addMessage(text, className) {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${className}`;
                messageEl.textContent = text;
                this.chatContainer.appendChild(messageEl);
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
                return messageEl;
            }
            
            updateLastMessage(text, className) {
                const messages = this.chatContainer.querySelectorAll('.message');
                const lastMessage = messages[messages.length - 1];
                if (lastMessage && lastMessage.classList.contains(className)) {
                    lastMessage.textContent = text;
                } else {
                    this.addMessage(text, className);
                }
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
            }
            
            addAudioToQueue(audioBase64, text) {
                const audioBlob = this.base64ToBlob(audioBase64, 'audio/wav');
                const audioUrl = URL.createObjectURL(audioBlob);
                
                this.audioQueue.push({
                    url: audioUrl,
                    text: text,
                    audio: new Audio(audioUrl)
                });
                
                this.updateAudioQueue();
                this.playNextAudio();
            }
            
            base64ToBlob(base64, mimeType) {
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], { type: mimeType });
            }
            
            updateAudioQueue() {
                this.audioQueueEl.textContent = `Audio queue: ${this.audioQueue.length} chunks`;
                this.playAllButton.style.display = this.audioQueue.length > 0 ? 'block' : 'none';
            }
            
            playNextAudio() {
                if (this.isPlaying || this.audioQueue.length === 0) return;
                
                this.isPlaying = true;
                const audioItem = this.audioQueue.shift();
                this.currentAudio = audioItem.audio;
                
                this.currentAudio.onended = () => {
                    URL.revokeObjectURL(audioItem.url);
                    this.isPlaying = false;
                    this.updateAudioQueue();
                    this.playNextAudio();
                };
                
                this.currentAudio.onerror = () => {
                    console.error('Audio playback error');
                    this.isPlaying = false;
                    this.updateAudioQueue();
                    this.playNextAudio();
                };
                
                this.currentAudio.play().catch(error => {
                    console.error('Audio play failed:', error);
                    this.isPlaying = false;
                    this.updateAudioQueue();
                    this.playNextAudio();
                });
            }
            
            showCloneStatus(message, type) {
                this.cloneStatus.textContent = message;
                this.cloneStatus.className = `clone-status ${type}`;
                
                // Clear status after 5 seconds
                setTimeout(() => {
                    this.cloneStatus.textContent = '';
                    this.cloneStatus.className = 'clone-status';
                }, 5000);
            }
            
            resetCloneForm() {
                this.cloneButton.disabled = false;
                this.cloneButton.textContent = 'Clone Voice';
                this.voiceNameInput.value = '';
                this.transcriptionInput.value = '';
                this.audioFileInput.value = '';
            }
            
            async cloneVoice() {
                const voiceName = this.voiceNameInput.value.trim();
                const transcription = this.transcriptionInput.value.trim();
                const audioFile = this.audioFileInput.files[0];
                
                if (!voiceName) {
                    this.showCloneStatus('Please enter a voice name', 'error');
                    return;
                }
                
                if (!audioFile) {
                    this.showCloneStatus('Please select an audio file', 'error');
                    return;
                }
                
                this.cloneButton.disabled = true;
                this.cloneButton.textContent = 'Cloning...';
                
                try {
                    // Convert audio file to base64
                    const audioBase64 = await this.fileToBase64(audioFile);
                    
                    // Send to server
                    this.ws.send(JSON.stringify({
                        type: 'clone_voice',
                        voice_name: voiceName,
                        transcription: transcription,
                        audio: audioBase64
                    }));
                    
                } catch (error) {
                    this.showCloneStatus(`Error: ${error.message}`, 'error');
                    this.cloneButton.disabled = false;
                    this.cloneButton.textContent = 'Clone Voice';
                }
            }
            
            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1]; // Remove data:audio/...;base64, prefix
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            
            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                
                this.cloneButton.addEventListener('click', () => this.cloneVoice());

                this.deleteVoiceButton.addEventListener('click', () => {
                    const voice = this.voiceSelect.value;
                    if (!voice) {
                        this.showCloneStatus('Select a voice to delete', 'error');
                        return;
                    }
                    if (!confirm(`Delete voice "${voice}" permanently?`)) return;
                    this.ws.send(JSON.stringify({
                        type: 'delete_voice',
                        voice_name: voice
                    }));
                });
                
                this.playAllButton.addEventListener('click', () => {
                    if (this.currentAudio) {
                        this.currentAudio.pause();
                        this.currentAudio.currentTime = 0;
                    }
                    this.isPlaying = false;
                    this.playNextAudio();
                });
            }
            
            sendMessage() {
                const message = this.messageInput.value.trim();
                const voice = this.voiceSelect.value;
                
                if (!message) return;
                
                // Add user message to chat
                this.addMessage(message, 'user-message');
                
                // Send to server
                this.ws.send(JSON.stringify({
                    type: 'chat',
                    message: message,
                    voice: voice
                }));
                
                // Clear input
                this.messageInput.value = '';
                this.sendButton.disabled = true;
                
                // Re-enable after a short delay
                setTimeout(() => {
                    this.sendButton.disabled = false;
                }, 1000);
            }
        }
        
        // Initialize the chat when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new VoiceChat();
        });
    </script>
</body>
</html>
    